pipeline {
  agent any

  options {
    timestamps()
    buildDiscarder(logRotator(numToKeepStr: '20'))
    timeout(time: 45, unit: 'MINUTES')
  }

  parameters {
    string(name: 'CUCUMBER_TAGS', defaultValue: '@smoke', description: 'Cucumber tags to run')
    choice(name: 'BROWSER', choices: ['chrome', 'firefox'], description: 'Browser for UI tests')
    booleanParam(name: 'HEADLESS', defaultValue: true, description: 'Run browser headless')
  }

  tools {
    maven 'MAVEN_HOME'   
    jdk 'JAVA_HOME'      
  }

  stages {
    stage('Checkout') {
      steps { checkout scm }
    }

    stage('Build (skip tests)') {
      steps { bat 'mvn -B -DskipTests clean compile' }
    }

    stage('Test') {
      steps {
        bat """
          mvn -B test ^
            -Dcucumber.filter.tags="${params.CUCUMBER_TAGS}" ^
            -Dbrowser="${params.BROWSER}" ^
            -Dheadless="${params.HEADLESS}"
        """
      }
     post {
       always {
           junit allowEmptyResults: true, testResults: 'target/surefire-reports/*.xml'
           archiveArtifacts allowEmptyArchive: true, artifacts: 'target/**'

     publishHTML(target: [
         allowMissing: false,
         alwaysLinkToLastBuild: true,
         keepAll: true,
         reportDir: 'target/reports',
         reportFiles: 'cucumber-report.html',
         reportName: 'Cucumber Report'
    ])
  }
}

    }
  }

  post {
    always { cleanWs(deleteDirs: true, disableDeferredWipeout: true) }
  }
}
